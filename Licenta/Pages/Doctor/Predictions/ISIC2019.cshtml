@page
@model Licenta.Pages.Doctor.Predictions.ISIC2019Model
@{
    ViewData["Title"] = "ISIC 2019 Prediction";
    bool hasResult = Model.Result != null && !string.IsNullOrWhiteSpace(Model.Result.Label);
}

@section Styles {
    <link rel="stylesheet" href="~/css/drpredictions.css" asp-append-version="true" />
}

<div class="page-container">

    <div class="page-header mb-3">
        <h2 class="page-title">
            <i class="bi bi-image text-primary"></i> ISIC 2019 Prediction
        </h2>
    </div>

    @if (TempData["StatusMessage"] is string status)
    {
        <div class="alert alert-info border-0 shadow-sm">@status</div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.TrainingBanner))
    {
        <div class="alert alert-warning border-0 shadow-sm">
            <i class="bi bi-hourglass-split me-2"></i>@Model.TrainingBanner
            @if (!string.IsNullOrWhiteSpace(Model.TrainingDetails))
            {
                <div class="mt-2 small text-muted">@Model.TrainingDetails</div>
            }
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="alert alert-danger border-0 shadow-sm">@Model.ErrorMessage</div>
    }

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Patient</label>
                            <select asp-for="PatientId" asp-items="Model.Patients" class="form-select">
                                <option value="">-- select patient --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Image</label>
                            <input asp-for="File" type="file" class="form-control" accept="image/*" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Model ID</label>
                            <input asp-for="ModelId" class="form-control" />
                            <div class="form-text">Example: isic_2019_images:torch_cnn</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Image size</label>
                            <input asp-for="ImageSize" class="form-control" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-play-circle me-2"></i>Run prediction
                        </button>

                        <div class="mt-3 d-flex justify-content-between">
                            <a asp-page="/Doctor/Predictions/Index" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </a>
                            <a asp-page="/Doctor/Predictions/ISIC2019" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh status
                            </a>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Result</h5>

                    @if (!hasResult)
                    {
                        <div class="text-muted">No result yet.</div>
                    }
                    else
                    {
                        <div class="fs-4 fw-bold">@Model.Result!.Label</div>
                        <div class="text-muted">
                            Confidence: @(Model.Result.EffectiveProbability?.ToString("P2") ?? "-")
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.SavedPredictionId))
                        {
                            <div class="mt-3">
                                <a asp-page="/Doctor/Predictions/Record"
                                   asp-route-id="@Model.SavedPredictionId"
                                   class="btn btn-outline-primary">
                                    View record
                                </a>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>