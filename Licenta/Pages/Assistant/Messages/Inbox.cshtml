@page
@model Licenta.Pages.Assistant.Messages.InboxModel
@{
    ViewData["Title"] = "Messages";
}

@section Styles {
    <link rel="stylesheet" href="~/css/assistant.css" />
    <link rel="stylesheet" href="~/css/InboxAssistant.css" />
}

<h2 class="mb-3">Messages</h2>

@if (!Model.Conversations.Any())
{
    <div class="alert alert-info">
        No conversations yet. Start a new conversation by messaging a user from other parts of the app.
    </div>
}
else
{
    <div class="chat-layout">
        <div class="chat-conversations">
            <div class="chat-conversations-header">
                Conversations
            </div>
            <div class="chat-conversations-list">
                @foreach (var c in Model.Conversations)
                {
                    var isActive = c.PartnerId == Model.SelectedUserId;
                    <a asp-page="/Assistant/Messages/Inbox"
                       asp-route-userId="@c.PartnerId"
                       class="text-decoration-none text-reset">
                        <div class="chat-conversation-item @(isActive ? "active" : "")">
                            <div class="chat-conversation-name">
                                @c.PartnerName
                            </div>
                            <div class="chat-conversation-last">
                                @c.LastMessagePreview
                            </div>
                        </div>
                    </a>
                }
            </div>
        </div>

        <div class="chat-window">
            @if (string.IsNullOrEmpty(Model.SelectedUserId))
            {
                <div class="p-4 text-muted">
                    Select a conversation from the left to start chatting.
                </div>
            }
            else
            {
                <div class="chat-window-header">
                    <div>
                        <div class="fw-semibold">@Model.SelectedUserName</div>
                        <div class="text-muted small">Internal chat</div>
                    </div>
                </div>

                <div class="chat-window-body">
                    @if (!Model.Messages.Any())
                    {
                        <div class="text-muted small">No messages yet. Start the conversation below.</div>
                    }
                    else
                    {
                        @foreach (var m in Model.Messages)
                        {
                            var mine = m.IsMine;
                            <div class="chat-message-row @(mine ? "me" : "other")">
                                <div class="chat-bubble @(mine ? "me" : "other")">
                                    <div>@m.Body</div>
                                    <div class="chat-message-meta">
                                        @m.SentAtLocal.ToString("g")
                                        @(mine ? " • You" : "")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="chat-window-footer">
                    <form method="post">
                        <input type="hidden" asp-for="Input.RecipientId" value="@Model.SelectedUserId" />
                        <div class="input-group">
                            <textarea asp-for="Input.NewMessageBody"
                                      class="form-control chat-input"
                                      rows="2"
                                      placeholder="Type a message..."></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <span asp-validation-for="Input.NewMessageBody" class="text-danger small"></span>
                    </form>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
